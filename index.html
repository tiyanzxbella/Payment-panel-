<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <meta name="HandheldFriendly" content="false">
  <title>Pembelian Produk Panel</title>
  <style>
    /* Universal Box-sizing untuk perhitungan layout yang lebih mudah dan akurat */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    /* ==================== VARIABEL TEMA ==================== */
    :root {
      /* Warna dasar */
      --primary-color: #7873f5;
      --secondary-color: #1fd1f9;
      --accent-color: #ff6ec4;
      
      /* Tema terang */
      --light-bg-image: url('https://files.catbox.moe/ele9lp.jpg');
      --light-bg-color: #f0f5ff;
      --light-card-bg: rgba(255, 255, 255, 0.9);
      --light-text-color: #333;
      --light-header-bg: rgba(0, 0, 0, 0.5);
      --light-footer-bg: rgba(0, 0, 0, 0.5);
      --light-footer-text: white;
      --light-border-color: #ddd;
      --light-chat-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 248, 248, 0.98));
      --light-chat-header-bg: linear-gradient(90deg, #7873f5, #1fd1f9);
      --light-chat-input-bg: #eef2f7;
      --light-chat-message-user: #cbe6ff;
      --light-chat-message-bot: #e9e9e9;
      --light-button-gradient: linear-gradient(45deg, #ff6ec4, #7873f5, #1fd1f9);
      --light-button-store-gradient: linear-gradient(45deg, #00c6ff, #0072ff, #a166cc);
      --light-glitch-text-shadow: 1px 1px 0 #ff00ff, -1px -1px 0 #00ffff;
      --light-qr-border: #7873f5;
      
      /* Tema gelap */
      --dark-bg-image: url('https://files.catbox.moe/1qy7vt.jpg');
      --dark-bg-color: #121220;
      --dark-card-bg: rgba(30, 30, 40, 0.9);
      --dark-text-color: #e0e0e0;
      --dark-header-bg: rgba(20, 20, 30, 0.8);
      --dark-footer-bg: rgba(20, 20, 30, 0.8);
      --dark-footer-text: #e0e0e0;
      --dark-border-color: #444;
      --dark-chat-bg: linear-gradient(135deg, rgba(30, 30, 40, 0.98), rgba(20, 20, 30, 0.98));
      --dark-chat-header-bg: linear-gradient(90deg, #5a56c4, #1a8da8);
      --dark-chat-input-bg: #1e1e2e;
      --dark-chat-message-user: #2a3a50;
      --dark-chat-message-bot: #2d2d3d;
      --dark-button-gradient: linear-gradient(45deg, #c55aa3, #5a56c4, #1a8da8);
      --dark-button-store-gradient: linear-gradient(45deg, #0099cc, #0055aa, #7a4ca0);
      --dark-glitch-text-shadow: 1px 1px 0 #cc00cc, -1px -1px 0 #00cccc;
      --dark-qr-border: #5a56c4;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      position: relative;
      overflow-x: hidden;
      background-image: var(--light-bg-image);
      background-size: cover;
      background-position: center;
      min-width: unset;
      background-attachment: fixed;
      background-color: var(--light-bg-color);
      color: var(--light-text-color);
      transition: background-image 0.5s ease, background-color 0.5s ease, color 0.3s ease;
    }

    body.dark-mode {
      background-image: var(--dark-bg-image);
      background-color: var(--dark-bg-color);
      color: var(--dark-text-color);
    }

    .produk-glitch {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      opacity: 0;
      background-size: cover;
      mix-blend-mode: difference;
      border-radius: 10px;
    }

    .produk-glitch::before, .produk-glitch::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: inherit;
      opacity: 0.5;
      border-radius: 10px;
    }

    .produk-glitch::before {
      left: 2px;
      animation: glitch-anim-1 2s infinite linear alternate-reverse;
      clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
    }

    .produk-glitch::after {
      left: -2px;
      animation: glitch-anim-2 2s infinite linear alternate-reverse;
      clip-path: polygon(0 60%, 100% 60%, 100% 100%, 0 100%);
    }

    @keyframes glitch-anim-1 {
      0% { transform: translate(2px, 2px); }
      100% { transform: translate(-2px, -2px); }
    }

    @keyframes glitch-anim-2 {
      0% { transform: translate(-2px, 2px); }
      100% { transform: translate(2px, -2px); }
    }

    .glitch-text {
      position: relative;
      text-shadow: var(--light-glitch-text-shadow);
    }

    body.dark-mode .glitch-text {
      text-shadow: var(--dark-glitch-text-shadow);
    }

    #barcode-container {
      text-align: center;
      margin-bottom: 20px;
    }

    #barcode-container img {
      width: 180px;
      height: 180px;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      border-radius: 12px;
      margin: 20px auto;
      display: block;
      transition: transform 0.3s ease;
      cursor: pointer;
      border: 5px solid var(--light-qr-border);
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    body.dark-mode #barcode-container img {
      border: 5px solid var(--dark-qr-border);
    }

    .produk-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      max-width: 460px;
      margin: 20px auto;
      padding: 0 10px;
    }

    .produk-item {
      border: 1px solid var(--light-border-color);
      padding: 20px;
      width: calc(50% - 10px);
      max-width: 200px;
      text-align: center;
      background-color: var(--light-card-bg);
      border-radius: 10px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    body.dark-mode .produk-item {
      border: 1px solid var(--dark-border-color);
      background-color: var(--dark-card-bg);
    }

    .produk-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .produk-item img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      margin-bottom: 10px;
      border-radius: 8px;
    }

    button {
      background-color: #333;
      color: #fff;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    button:hover {
      background-color: #555;
    }

    .btn-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .payment-btn {
      background: var(--light-button-gradient);
      background-size: 200% 200%;
      animation: gradientBtn 4s ease infinite;
      color: #fff;
      font-weight: 600;
      border-radius: 12px;
      text-decoration: none;
      transition: 0.3s;
      padding: 14px 24px;
      display: inline-block;
    }

    body.dark-mode .payment-btn {
      background: var(--dark-button-gradient);
    }

    .store-btn {
      background: var(--light-button-store-gradient);
      background-size: 200% 200%;
      animation: gradientBtn 4s ease infinite;
      color: #fff;
      font-weight: 600;
      border-radius: 12px;
      text-decoration: none;
      transition: 0.3s;
      padding: 14px 24px;
      display: inline-block;
    }

    body.dark-mode .store-btn {
      background: var(--dark-button-store-gradient);
    }

    .payment-btn:hover, .store-btn:hover {
      transform: scale(1.05);
    }

    @keyframes gradientBtn {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple-animation 0.6s linear;
      background-color: rgba(255, 255, 255, 0.7);
      pointer-events: none;
      z-index: 1000;
    }

    @keyframes ripple-animation {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    footer {
      text-align: center;
      margin: 30px 0;
      font-size: 16px;
      color: var(--light-footer-text);
      background-color: var(--light-footer-bg);
      padding: 15px;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    body.dark-mode footer {
      color: var(--dark-footer-text);
      background-color: var(--dark-footer-bg);
    }

    footer a {
      color: inherit;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    footer a:hover {
      transform: scale(1.1);
    }

    .social-icon {
      width: 24px;
      height: 24px;
      vertical-align: middle;
    }

    canvas#salju {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 9999;
    }

    h1 {
      text-align: center;
      color: white;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      background-color: var(--light-header-bg);
      padding: 15px;
      margin: 0 0 20px 0;
      border-radius: 5px;
    }

    body.dark-mode h1 {
      background-color: var(--dark-header-bg);
    }

    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10001;
    }

    .popup-content {
        background-color: white;
        padding: 30px 40px;
        border-radius: 10px;
        text-align: center;
        width: 80%;
        max-width: 450px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        color: #333;
        font-size: 18px;
    }

    body.dark-mode .popup-content {
      background-color: #2a2a3a;
      color: #e0e0e0;
    }

    .popup-content h2 {
        margin-top: 0;
        color: #e63946;
        background-color: transparent;
        text-shadow: none;
        padding: 0;
        margin-bottom: 15px;
        font-size: 24px;
    }

    body.dark-mode .popup-content h2 {
      color: #ff6b6b;
    }

    .popup-content p {
        margin-bottom: 25px;
        line-height: 1.6;
    }

    .popup-content button {
        background-color: #007bff;
        color: #fff;
        padding: 12px 25px;
        border-radius: 8px;
        font-size: 16px;
    }

    body.dark-mode .popup-content button {
      background-color: #4a86e8;
    }

    .popup-content button:hover {
        background-color: #0056b3;
    }

    body.dark-mode .popup-content button:hover {
      background-color: #3a76d8;
    }

    .desktop-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
      position: relative;
      border: 2px solid #a166cc;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }

    #music-control {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      color: white;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    #music-control:hover {
      background-color: rgba(0, 0, 0, 0.9);
      transform: scale(1.1);
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      color: white;
      font-size: 24px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* STYLE CHAT AI */
    .chat-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 95%;
      height: 80%;
      max-width: 900px;
      max-height: 700px;
      background: var(--light-chat-bg);
      z-index: 2000;
      display: none;
      border-radius: 15px;
      box-shadow: 0 0 25px rgba(0,0,0,0.4);
      flex-direction: column;
    }

    body.dark-mode .chat-container {
      background: var(--dark-chat-bg);
    }

    .chat-header {
      display: flex;
      padding: 20px;
      background: var(--light-chat-header-bg);
      color: white;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      justify-content: space-between;
    }

    body.dark-mode .chat-header {
      background: var(--dark-chat-header-bg);
    }

    .chat-header button {
      background-color: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 20px;
    }

    .chat-title {
      flex-grow: 1;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }

    .chat-body {
      padding: 20px;
      height: calc(100% - 180px);
      overflow-y: auto;
      font-size: 18px;
      background-color: #f5f8fb;
      scroll-behavior: smooth;
      scrollbar-width: thin;
      scrollbar-color: #a8b9c9 #f1f1f1;
    }

    body.dark-mode .chat-body {
      background-color: #1a1a2a;
      scrollbar-color: #4a4a6a #1a1a2a;
    }

    .chat-body::-webkit-scrollbar {
      width: 8px;
    }

    .chat-body::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    body.dark-mode .chat-body::-webkit-scrollbar-track {
      background: #1a1a2a;
    }

    .chat-body::-webkit-scrollbar-thumb {
      background-color: #b0c4de;
      border-radius: 10px;
      border: 2px solid #f5f8fb;
    }

    body.dark-mode .chat-body::-webkit-scrollbar-thumb {
      background-color: #4a4a6a;
      border: 2px solid #1a1a2a;
    }

    .chat-body::-webkit-scrollbar-thumb:hover {
      background-color: #90a8c0;
    }

    body.dark-mode .chat-body::-webkit-scrollbar-thumb:hover {
      background-color: #6a6a8a;
    }

    .chat-message {
      margin-bottom: 15px;
      padding: 12px 15px;
      border-radius: 10px;
      max-width: 80%;
      font-size: 18px;
      line-height: 1.5;
      word-wrap: break-word;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .user-message {
      background-color: var(--light-chat-message-user);
      margin-left: auto;
      border-bottom-right-radius: 5px;
    }

    body.dark-mode .user-message {
      background-color: var(--dark-chat-message-user);
    }

    .bot-message {
      background-color: var(--light-chat-message-bot);
      margin-right: auto;
      border-bottom-left-radius: 5px;
    }

    body.dark-mode .bot-message {
      background-color: var(--dark-chat-message-bot);
    }

    .chat-input {
      padding: 15px;
      background-color: var(--light-chat-input-bg);
      border-top: 1px solid var(--light-border-color);
      display: flex;
      align-items: center;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }

    body.dark-mode .chat-input {
      background-color: var(--dark-chat-input-bg);
      border-top: 1px solid var(--dark-border-color);
    }

    .chat-input input[type="text"] {
      width: calc(100% - 140px);
      padding: 15px;
      border: 1px solid #c0c0c0;
      border-radius: 8px;
      margin-right: 15px;
      font-size: 18px;
      background-color: white;
      color: #333;
    }

    body.dark-mode .chat-input input[type="text"] {
      background-color: #2a2a3a;
      color: #e0e0e0;
      border-color: #555;
    }

    .chat-input button {
      background-color: #333;
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s;
    }

    .chat-input button:hover {
      background-color: #555;
    }

    .chat-nav {
      display: flex;
      justify-content: space-around;
      padding: 15px;
      background-color: var(--light-chat-input-bg);
      border-top: 1px solid var(--light-border-color);
    }

    body.dark-mode .chat-nav {
      background-color: var(--dark-chat-input-bg);
      border-top: 1px solid var(--dark-border-color);
    }

    .chat-nav button {
      margin: 0 10px;
      flex-grow: 1;
      max-width: 300px;
      font-size: 18px;
      padding: 15px 25px;
    }

    /* Tombol AI Assistant */
    #chat-button {
      position: absolute;
      top: 5px;
      right: 20px;
      background: linear-gradient(45deg, #00c6ff, #0072ff, #a166cc);
      background-size: 200% 200%;
      animation: gradientBtn 4s ease infinite;
      color: #fff;
      font-weight: 600;
      border-radius: 12px;
      padding: 8px 15px;
      cursor: pointer;
      text-align: center;
      z-index: 1000;
      transition: transform 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      border: none;
    }

    #chat-button:hover {
      transform: scale(1.05);
    }

    #chat-button p {
      margin: 0;
    }

    .chat-icon {
      width: 18px;
      height: 18px;
    }

    /* Tombol Mode Gelap/Terang */
    #theme-toggle {
      position: absolute;
      top: 5px;
      left: 20px;
      background: linear-gradient(45deg, #ff9a00, #ff5500);
      background-size: 200% 200%;
      animation: gradientBtn 4s ease infinite;
      color: #fff;
      font-weight: 600;
      border-radius: 12px;
      padding: 8px 15px;
      cursor: pointer;
      text-align: center;
      z-index: 1000;
      transition: transform 0.3s ease;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      border: none;
    }

    #theme-toggle:hover {
      transform: scale(1.05);
    }

    #theme-toggle p {
      margin: 0;
    }

    .theme-icon {
      width: 18px;
      height: 18px;
    }

    /* STYLE TAMBAHAN UNTUK AI CHAT */
    .message-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      align-items: center;
    }
    
    .typing-dots {
      display: inline-block;
      position: relative;
    }
    
    .typing-dots::after {
      content: "...";
      animation: typing 1.5s infinite;
      position: absolute;
      left: 0;
    }
    
    @keyframes typing {
      0% { content: "."; }
      33% { content: ".."; }
      66% { content: "..."; }
    }
    
    .suggested-questions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .suggested-question {
      background-color: #d8e2ed;
      padding: 8px 12px;
      border-radius: 15px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
      width: calc(50% - 10px);
      text-align: center;
      flex-shrink: 0;
    }

    body.dark-mode .suggested-question {
      background-color: #3a3a4a;
      color: #e0e0e0;
    }
    
    .suggested-question:hover {
      background-color: #cbe6ff;
    }

    body.dark-mode .suggested-question:hover {
      background-color: #4a4a5a;
    }
    
    .chat-message pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    body.dark-mode .chat-message pre {
      background-color: #2a2a3a;
    }
    
    .chat-message code {
      font-family: monospace;
      background-color: #f5f5f5;
      padding: 2px 4px;
      border-radius: 3px;
    }

    body.dark-mode .chat-message code {
      background-color: #2a2a3a;
    }
    
    .chat-message a {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.2s;
    }

    body.dark-mode .chat-message a {
      color: #4a86e8;
    }
    
    .chat-message a:hover {
      text-decoration: underline;
      color: #0056b3;
    }

    body.dark-mode .chat-message a:hover {
      color: #3a76d8;
    }
    
    .chat-history-btn {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .history-icon {
      width: 18px;
      height: 18px;
    }
    
    .chat-history-panel {
      position: absolute;
      top: 0;
      right: -350px;
      width: 350px;
      height: 100%;
      background-color: #f5f8fb;
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      transition: right 0.3s ease;
      overflow-y: auto;
      padding: 20px;
      z-index: 10;
      display: none;
    }

    body.dark-mode .chat-history-panel {
      background-color: #1a1a2a;
    }
    
    .chat-history-panel.active {
      right: 0;
      display: block;
    }
    
    .chat-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }

    body.dark-mode .chat-history-header {
      border-bottom: 1px solid #444;
    }
    
    .chat-history-item {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      background-color: #eaf1f7;
      cursor: pointer;
      transition: background-color 0.3s;
      animation: fadeIn 0.3s ease-out;
    }

    body.dark-mode .chat-history-item {
      background-color: #2a2a3a;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .chat-history-item:hover {
      background-color: #d8e2ed;
    }

    body.dark-mode .chat-history-item:hover {
      background-color: #3a3a4a;
    }
    
    .chat-history-item h4 {
      margin: 0 0 5px 0;
      color: #333;
    }

    body.dark-mode .chat-history-item h4 {
      color: #e0e0e0;
    }
    
    .chat-history-item p {
      margin: 0;
      color: #666;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    body.dark-mode .chat-history-item p {
      color: #aaa;
    }
    
    .chat-history-item .time {
      font-size: 12px;
      color: #999;
      text-align: right;
    }

    body.dark-mode .chat-history-item .time {
      color: #888;
    }
    
    .no-history {
      color: #999;
      text-align: center;
      margin-top: 50px;
    }

    body.dark-mode .no-history {
      color: #777;
    }
    
    .close-history {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }

    body.dark-mode .close-history {
      color: #aaa;
    }
    
    .clear-history-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 15px;
      width: 100%;
      transition: background-color 0.3s;
    }
    
    .clear-history-btn:hover {
      background-color: #c0392b;
    }
    
    .ai-notification {
      background-color: #e6f2e6;
      border-left: 4px solid #4CAF50;
      padding: 10px;
      margin-top: 10px;
      font-size: 14px;
      border-radius: 0 5px 5px 0;
    }

    body.dark-mode .ai-notification {
      background-color: #2e3a2e;
      border-left: 4px solid #4CAF50;
    }

    /* ==================== MEDIA QUERIES UNTUK LAYAR KECIL (MOBILE) ==================== */
    @media (max-width: 768px) {
      .desktop-container {
        padding: 10px;
      }

      h1 {
        font-size: 28px;
        padding: 10px;
      }

      .produk-wrapper {
        max-width: 100%;
        padding: 0 5px;
        gap: 10px;
      }

      .produk-item {
        width: calc(50% - 5px);
        max-width: 180px;
        padding: 15px;
      }
      
      .produk-item img {
        width: 80px;
        height: 80px;
      }

      .btn-container {
        flex-direction: column;
        gap: 15px;
      }

      .payment-btn, .store-btn {
        width: 90%;
        max-width: 300px;
        margin: 0 auto;
        padding: 12px 20px;
        font-size: 16px;
      }

      footer {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
        font-size: 14px;
      }
      
      #chat-button {
        top: 5px;
        right: 5px;
        padding: 6px 10px;
        font-size: 12px;
      }
      
      #theme-toggle {
        top: 5px;
        left: 5px;
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .chat-icon, .theme-icon {
        width: 16px;
        height: 16px;
      }

      .popup-content {
        padding: 20px 30px;
        font-size: 16px;
      }
      
      .popup-content h2 {
        font-size: 20px;
      }
      
      .popup-content p {
        margin-bottom: 20px;
      }
      
      .popup-content button {
        padding: 10px 20px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <canvas id="salju"></canvas>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p id="loading-text">Mengarahkan...</p>
  </div>

  <div id="popup-warning" class="popup-overlay">
      <div class="popup-content">
          <h2>Peringatan Perangkat Mobile</h2>
          <p>⚠️ Untuk pengalaman visual dan fungsionalitas terbaik, sangat disarankan menggunakan perangkat desktop atau mengaktifkan mode desktop pada browser mobile Anda, dan disarankan untuk berhati-hati dalam bertransaksi pada siapapun dan dimanapun. ⚠️</p>
          <button id="close-popup">Saya Mengerti</button>
      </div>
  </div>

  <audio id="background-music" loop>
    <source src="https://nathanprinsley-files.prinsh.com/data-1/mp3/safe-and-sound_rebelution.mp3" type="audio/mpeg">
    Browser Anda tidak mendukung elemen audio.
  </audio>

  <div id="music-control" title="Play/Pause Music">♪</div>

  <div class="desktop-container">
    <!-- Tombol Mode Gelap/Terang -->
    <button id="theme-toggle">
      <svg class="theme-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
        <path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"/>
        <path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"/>
        <path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"/>
        <path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.1,6.5,5.9,6.6,5.6,6.6z"/>
        <path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20.1,20.8,19.8,20.8z"/>
        <path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"/>
        <path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"/>
        <path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"/>
        <path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.7,6.6,18.4,6.6z"/>
      </svg>
      <p>Mode</p>
    </button>
    
    <!-- Tombol AI Assistant -->
    <div id="chat-button">
      <svg class="chat-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
        <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
      </svg>
      <p>AI Assistant</p>
    </div>

    <div id="barcode-container">
      <img id="barcode" src="https://cdn.xtermai.xyz/i47/42" alt="Barcode">
    </div>

    <h1 class="glitch-text">Pembelian Produk Panel</h1>
    <div id="produk" class="produk-wrapper"></div>

    <div class="btn-container">
      <button class="store-btn" id="go-to-store">Lanjut ke Web Store</button>
      <button class="payment-btn" id="go-to-payment-page">Lanjut ke Pembayaran</button>
    </div>

    <footer>
      <a href="https://instagram.com/septiyanda_putra" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram" class="social-icon">
        @septiyanda_putra
      </a>
      <a href="https://chat.whatsapp.com/EQkSNg1QgWG0pEaGWwdnuv" target="_blank">
        <img src="https://cdn-icons-png.flaticon.com/512/220/220236.png" alt="WhatsApp" class="social-icon">
        Grup WhatsApp
      </a>
    </footer>
  </div>

  <div class="chat-container" id="chat-container">
    <div class="chat-header">
      <button id="close-chat">✕</button>
      <div class="chat-title">AI Assistant Pembelian</div>
      <button class="chat-history-btn" id="show-history">
        <svg class="history-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
          <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
        </svg>
        Riwayat
      </button>
      <div id="typing-indicator" style="margin-left: auto; display: none; color: #666; font-size: 14px;">
        <span class="typing-dots">...</span>
      </div>
    </div>
    
    <div class="chat-history-panel" id="chat-history-panel">
      <div class="chat-history-header">
        <h3>Riwayat Percakapan</h3>
        <button class="close-history" id="close-history">✕</button>
      </div>
      <div id="history-list">
        <div class="no-history">Tidak ada riwayat percakapan</div>
      </div>
      <button class="clear-history-btn" id="clear-history-btn">Hapus Semua Riwayat</button>
    </div>
    
    <div class="chat-body" id="chat-body">
      <!-- Pesan akan dimuat secara dinamis -->
    </div>
    <div class="chat-input">
      <input type="text" id="chat-input" placeholder="Ketik pesan Anda..." autocomplete="off">
      <button id="send-button">Kirim</button>
    </div>
    <div class="chat-nav">
      <button class="store-btn" id="chat-go-to-store">Lanjut ke Web Store</button>
      <button class="payment-btn" id="chat-go-to-payment">Lanjut ke Pembayaran</button>
    </div>
  </div>

  <script>
    // ==================== TOGGLE TEMA ====================
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle.querySelector('.theme-icon');
    
    // Cek preferensi tema dari localStorage
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      // Update ikon tema
      themeIcon.innerHTML = '<path d="M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/>';
    }
    
    // Event listener untuk toggle tema
    themeToggle.addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      
      // Simpan preferensi tema
      if (document.body.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark');
        // Update ikon menjadi bulan
        themeIcon.innerHTML = '<path d="M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/>';
      } else {
        localStorage.setItem('theme', 'light');
        // Update ikon menjadi matahari
        themeIcon.innerHTML = '<path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"/><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"/><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"/><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.1,6.5,5.9,6.6,5.6,6.6z"/><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20.1,20.8,19.8,20.8z"/><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"/><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"/><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"/><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.7,6.6,18.4,6.6z"/>';
      }
    });

    // ==================== MUSIK OTOMATIS ====================
    const backgroundMusic = document.getElementById('background-music');
    const musicControl = document.getElementById('music-control');
    let isMusicPlaying = false;

    function tryPlayMusic() {
        backgroundMusic.volume = 0.3;
        const playPromise = backgroundMusic.play();

        if (playPromise !== undefined) {
            playPromise.then(() => {
                isMusicPlaying = true;
                musicControl.textContent = '❚❚';
            }).catch(error => {
                isMusicPlaying = false;
                musicControl.textContent = '♪';
                console.log("Music play prevented:", error);
            });
        } else {
            isMusicPlaying = true;
            musicControl.textContent = '❚❚';
        }
    }

    function toggleMusic() {
      if (isMusicPlaying) {
        backgroundMusic.pause();
        isMusicPlaying = false;
        musicControl.textContent = '♪';
      } else {
        tryPlayMusic();
      }
    }

    musicControl.addEventListener('click', toggleMusic);

    // ==================== QRIS INTERAKTIF ====================
    const barcodeImage = document.getElementById('barcode');
    if (barcodeImage) {
      barcodeImage.addEventListener('click', function() {
        const imageUrl = this.src;
        window.open(imageUrl, '_blank');
      });
    }

    // ==================== PRODUK DAN FUNGSIONALITAS UTAMA ====================
    const produk = [
      { id: 1, nama: 'Panel 1GB', harga: 1000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 2, nama: 'Panel 2GB', harga: 2000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 3, nama: 'Panel 3GB', harga: 3000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 4, nama: 'Panel 4GB', harga: 4000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 5, nama: 'Panel 5GB', harga: 5000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 6, nama: 'Panel 6GB', harga: 6000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 7, nama: 'Panel 7GB', harga: 7000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 8, nama: 'Panel 8GB', harga: 8000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 9, nama: 'Panel 9GB', harga: 9000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 10, nama: 'Panel 10GB', harga: 10000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
      { id: 11, nama: 'Panel Unli', harga: 15000, gambar: 'https://cdn.xtermai.xyz/i6/8LYhd' },
    ];

    const produkContainer = document.getElementById('produk');
    produkContainer.innerHTML = '';
    for (let i = 0; i < produk.length; i++) {
      const item = produk[i];
      const itemDiv = document.createElement('div');
      itemDiv.classList.add('produk-item');
      itemDiv.innerHTML = `
        <img src="${item.gambar}" alt="${item.nama}">
        <h2>${item.nama}</h2>
        <p>Rp ${item.harga.toLocaleString()}</p>
        <button onclick="beliProduk(${item.id}, event)">Beli</button>
      `;
      produkContainer.appendChild(itemDiv);
    }

    function beliProduk(id, event) {
      const produkDipilih = produk.find((item) => item.id === id);
      if (produkDipilih) {
        createRipple(event);
        const productItem = event.currentTarget.closest('.produk-item');
        const glitch = productItem.querySelector('.produk-glitch');
        if (glitch) {
          glitch.style.opacity = '0.5';
          setTimeout(() => {
            glitch.style.opacity = '0';
          }, 300);
        }
        const pesan = `Halo, saya ingin membeli ${produkDipilih.nama} seharga Rp ${produkDipilih.harga}`;
        const nomorWhatsApp = '6285972533957';
        const urlWhatsApp = `https://wa.me/${nomorWhatsApp}?text=${encodeURIComponent(pesan)}`;
        setTimeout(() => {
          window.open(urlWhatsApp, '_blank');
        }, 300);
      } else {
        alert('Produk tidak ditemukan');
      }
    }

    function createRipple(event) {
      const button = event.currentTarget;
      const circle = document.createElement("span");
      const diameter = Math.max(button.clientWidth, button.clientHeight);
      const radius = diameter / 2;
      circle.classList.add("ripple");
      circle.style.width = circle.style.height = `${diameter}px`;
      circle.style.left = `${event.offsetX - radius}px`;
      circle.style.top = `${event.offsetY - radius}px`;
      button.appendChild(circle);
    }

    document.getElementById('go-to-store').addEventListener('click', function() {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loading-text').textContent = 'Mengarahkan ke Web Store...';
      setTimeout(() => {
        window.location.href = 'https://buylink.id/Tiyanstore';
      }, 1000);
    });

    document.getElementById('go-to-payment-page').addEventListener('click', function() {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loading-text').textContent = 'Mengarahkan ke halaman pembayaran...';
      setTimeout(() => {
        window.location.href = 'https://tiyanpalestine.github.io/Website-payment/';
      }, 1000);
    });

    // ==================== AI CHAT ====================
    const chatButton = document.getElementById('chat-button');
    const chatContainer = document.getElementById('chat-container');
    const closeChatButton = document.getElementById('close-chat');
    const chatBody = document.getElementById('chat-body');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const typingIndicator = document.getElementById('typing-indicator');
    const showHistoryBtn = document.getElementById('show-history');
    const chatHistoryPanel = document.getElementById('chat-history-panel');
    const closeHistoryBtn = document.getElementById('close-history');
    const historyList = document.getElementById('history-list');
    const clearHistoryBtn = document.getElementById('clear-history-btn');

    let conversationHistory = [];
    const CHAT_HISTORY_KEY = 'yolaAssistantChatHistory';
    const MAX_HISTORY_ITEMS = 10;

    function initChat() {
      clearChat();
    }

    function clearChat() {
      chatBody.innerHTML = '';
      conversationHistory = [];
      addWelcomeMessage();
    }

    function addWelcomeMessage() {
      conversationHistory = [{ 
        role: "assistant", 
        content: "Halo! Saya adalah AI Assistant yang siap membantu Anda dengan pertanyaan seputar produk dan pembelian.\n\nAnda bisa menanyakan tentang:\n- Detail produk dan spesifikasi\n- Harga dan promo terbaru\n- Metode pembayaran yang tersedia\n- Status pesanan\n- grup wa/grup bot\n\nBagaimana saya bisa membantu Anda hari ini?" 
      }];

      const welcomeMessageHtml = `
        <div class="chat-message bot-message">
          <div class="message-header">
            <strong>AI Assistant</strong>
            <span class="message-time">${getCurrentTime()}</span>
          </div>
          ${formatMessageWithLinks(conversationHistory[0].content).innerHTML}
          ${addSuggestedQuestionsHTML()}
          <div class="ai-notification">
            <strong>Penting:</strong> AI ini dapat mengenali kata-kata dengan typo seperti "prodiukk", "pembayaran", "harga", dll.
          </div>
        </div>
      `;
      
      chatBody.innerHTML = welcomeMessageHtml;
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    const suggestedQuestions = [
      "Apa saja produk yang tersedia?",
      "Bagaimana cara melakukan pembayaran?",
      "Apakah ada promo saat ini?",
      "Berapa harga panel 5GB?",
      "Bagaimana cara menghubungi customer service?",
      "Bagaimana cara bergabung ke Grup WhatsApp?"
    ];

    function addSuggestedQuestionsHTML() {
      let html = '<div class="suggested-questions">';
      suggestedQuestions.forEach(question => {
        html += `<div class="suggested-question" onclick="setSuggestedQuestion('${question.replace(/'/g, "\\'")}')">${question}</div>`;
      });
      html += '</div>';
      return html;
    }

    function setSuggestedQuestion(question) {
      chatInput.value = question;
      sendMessage(); 
    }

    showHistoryBtn.addEventListener('click', function() {
      if (chatHistoryPanel.style.display === 'none' || !chatHistoryPanel.style.display) {
        loadChatHistory();
        chatHistoryPanel.style.display = 'block';
        setTimeout(() => {
          chatHistoryPanel.style.right = '0';
        }, 10);
      } else {
        chatHistoryPanel.style.right = '-350px';
        setTimeout(() => {
          chatHistoryPanel.style.display = 'none';
        }, 300);
      }
    });

    closeHistoryBtn.addEventListener('click', function() {
      chatHistoryPanel.style.right = '-350px';
      setTimeout(() => {
        chatHistoryPanel.style.display = 'none';
      }, 300);
    });

    function getChatHistory() {
      const saved = localStorage.getItem(CHAT_HISTORY_KEY);
      return saved ? JSON.parse(saved) : [];
    }

    function saveCurrentConversationToHistory() {
      if (conversationHistory.length > 1) {
        const chatData = {
          id: Date.now(),
          timestamp: Date.now(),
          messages: [...conversationHistory],
          preview: conversationHistory.find(msg => msg.role === 'user')?.content.substring(0, 100) || "Percakapan baru"
        };

        let history = getChatHistory();
        history.push(chatData);
        if (history.length > MAX_HISTORY_ITEMS) {
          history = history.slice(history.length - MAX_HISTORY_ITEMS);
        }
        localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
      }
    }

    function loadChatHistory() {
      const savedChats = getChatHistory();
      historyList.innerHTML = '';
      
      if (savedChats.length === 0) {
        historyList.innerHTML = '<div class="no-history">Tidak ada riwayat percakapan</div>';
      } else {
        savedChats.slice().reverse().forEach((chat) => {
          const chatItem = document.createElement('div');
          chatItem.className = 'chat-history-item';
          
          const chatDate = new Date(chat.timestamp);
          const formattedDate = chatDate.toLocaleDateString('id-ID', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
          });
          const formattedTime = chatDate.toLocaleTimeString('id-ID', {
            hour: '2-digit',
            minute: '2-digit'
          });
          
          chatItem.innerHTML = `
            <h4>Percakapan pada ${formattedDate}</h4>
            <p>${chat.preview}</p>
            <div class="time">${formattedTime}</div>
          `;
          
          chatItem.addEventListener('click', () => {
            loadSelectedChat(chat.messages);
            chatHistoryPanel.style.right = '-350px';
            setTimeout(() => {
              chatHistoryPanel.style.display = 'none';
            }, 300);
          });
          
          historyList.appendChild(chatItem);
        });
      }
    }

    function clearAllChatHistory() {
      if (confirm('Apakah Anda yakin ingin menghapus semua riwayat percakapan? Tindakan ini tidak dapat dibatalkan.')) {
        localStorage.removeItem(CHAT_HISTORY_KEY);
        loadChatHistory();
        alert('Semua riwayat percakapan telah dihapus.');
      }
    }

    clearHistoryBtn.addEventListener('click', clearAllChatHistory);

    function loadSelectedChat(messages) {
      chatBody.innerHTML = '';
      conversationHistory = [...messages];
      
      messages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${msg.role === 'user' ? 'user-message' : 'bot-message'}`;
        
        const header = document.createElement('div');
        header.className = 'message-header';
        header.innerHTML = `<strong>${msg.role === 'user' ? 'Anda' : 'AI Assistant'}</strong><span class="message-time">${getCurrentTime()}</span>`;
        
        messageDiv.appendChild(header);
        
        const contentDiv = formatMessageWithLinks(msg.content);
        messageDiv.appendChild(contentDiv);
        
        chatBody.appendChild(messageDiv);
      });
      
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function formatMessageWithLinks(text) {
      const div = document.createElement('div');
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      
      const lines = text.split('\n');

      lines.forEach((line, lineIndex) => {
        const lineFragment = document.createDocumentFragment();
        let lastIndex = 0;
        
        const matches = [...line.matchAll(urlRegex)];
        
        matches.forEach(match => {
          const url = match[0];
          const matchIndex = match.index;
          
          if (matchIndex > lastIndex) {
            lineFragment.appendChild(document.createTextNode(line.substring(lastIndex, matchIndex)));
          }
          
          const link = document.createElement('a');
          link.href = url;
          link.textContent = url;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.style.color = '#007bff';
          link.style.textDecoration = 'none';
          link.style.fontWeight = 'bold';
          link.style.cursor = 'pointer';
          link.addEventListener('mouseover', () => { link.style.textDecoration = 'underline'; });
          link.addEventListener('mouseout', () => { link.style.textDecoration = 'none'; });
          lineFragment.appendChild(link);
          
          lastIndex = matchIndex + url.length;
        });
        
        if (lastIndex < line.length) {
          lineFragment.appendChild(document.createTextNode(line.substring(lastIndex)));
        }
        
        div.appendChild(lineFragment);
        
        if (lineIndex < lines.length - 1) {
          div.appendChild(document.createElement('br'));
        }
      });
      
      return div;
    }

    function showTypingIndicator() {
      typingIndicator.style.display = 'block';
    }

    function hideTypingIndicator() {
      typingIndicator.style.display = 'none';
    }

    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function recognizeTypo(word) {
      const keywordMap = {
        'produk': ['prodiuk', 'prodak', 'produck', 'produt', 'prooduk', 'produkt'],
        'pembayaran': ['pembayran', 'pembayarn', 'pembayran', 'pembayarran', 'bayar', 'payment'],
        'harga': ['hargga', 'harha', 'harg', 'harganya', 'price', 'brp'],
        'panel': ['panell', 'pannel', 'panal', 'penel'],
        'unli': ['unli', 'unlimited', 'unlimeted', 'unl'],
        'gb': ['gb', 'g', 'gigabyte', 'giga'],
        'whatsapp': ['wa', 'whatsapp', 'watsapp', 'whatsap', 'grup wa', 'grup bot'],
        'cs': ['cs', 'customer service', 'cust service', 'cust svc', 'bantuan', 'kontak']
      };
      
      const normalizedWord = word.toLowerCase().trim();
      
      for (const [correctWord, variations] of Object.entries(keywordMap)) {
        if (variations.includes(normalizedWord) || normalizedWord.includes(correctWord)) {
          return correctWord;
        }
      }
      
      return word;
    }

    async function getAIResponse(message) {
      await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1500));
      
      const words = message.toLowerCase().split(/\s+/);
      const normalizedWords = words.map(word => recognizeTypo(word));
      const normalizedMessage = normalizedWords.join(' ');
      
      if (normalizedMessage.includes('produk') || normalizedMessage.includes('panel') || normalizedMessage.includes('gb')) {
        if (normalizedMessage.includes('1gb') || normalizedMessage.includes('satu')) {
          return "Panel 1GB dijual dengan harga Rp 1.000. Produk ini cocok untuk penggunaan ringan dengan kuota 1GB.\n\nFitur:\n- Kecepatan tinggi\n- Masa aktif 30 hari\n- Support 24/7\n\nKunjungi https://buylink.id/Tiyanstore untuk informasi lebih lanjut.";
        } else if (normalizedMessage.includes('2gb') || normalizedMessage.includes('dua')) {
          return "Panel 2GB tersedia dengan harga Rp 2.000. Kuota 2GB ini cocok untuk penggunaan menengah.\n\nKeuntungan:\n- Bisa dibagi ke beberapa perangkat\n- Tanpa throttle kecepatan\n- Garansi pengisian ulang\n\nLihat detail di https://buylink.id/Tiyanstore";
        } else if (normalizedMessage.includes('unli') || normalizedMessage.includes('unlimited')) {
          return "Panel Unlimited adalah paket premium kami dengan harga Rp 15.000. Anda mendapatkan:\n\n- Kuota tanpa batas\n- Kecepatan stabil 24/7\n- Prioritas jaringan\n- Masa aktif 30 hari\n\nPilihan terbaik untuk penggunaan berat! Info lengkap: https://buylink.id/Tiyanstore";
        } else if (normalizedMessage.includes('harga') || normalizedMessage.includes('price') || normalizedMessage.includes('berapa')) {
          return "Berikut daftar harga produk kami:\n\n1GB  : Rp 1.000\n2GB  : Rp 2.000\n3GB  : Rp 3.000\n4GB  : Rp 4.000\n5GB  : Rp 5.000\n...\n10GB : Rp 10.000\nUnli: Rp 15.000\n\nHarga sudah termasuk PPN. Kunjungi https://buylink.id/Tiyanstore untuk melihat detail setiap produk.";
        } else {
          return "Kami menyediakan berbagai panel dengan kuota mulai dari 1GB hingga Unlimited. Setiap produk memiliki keunggulan:\n\n- Panel Reguler (1GB-10GB): Harga ekonomis\n- Panel Unlimited: Tanpa batas kuota\n\nProduk kami mendukung semua operator utama dengan koneksi stabil. Kunjungi https://buylink.id/Tiyanstore untuk informasi lengkap. Ada yang bisa saya bantu lebih spesifik?";
        }
      }
      else if (normalizedMessage.includes('pembayaran') || normalizedMessage.includes('bayar') || normalizedMessage.includes('payment')) {
        return "Kami menerima berbagai metode pembayaran:\n\n1. Transfer Bank (BCA, BRI, Mandiri, BNI)\n2. E-Wallet (DANA, OVO, ShopeePay, Gopay)\n3. QRIS\n4. Alfamart/Indomaret\n\nSetelah pembayaran, produk akan dikirim secara instan ke email Anda. Untuk petunjuk lengkap, kunjungi https://tiyanpalestine.github.io/Website-payment/ atau klik tombol 'Lanjut ke Pembayaran' di bawah.";
      }
      else if (normalizedMessage.includes('promo') || normalizedMessage.includes('diskon') || normalizedMessage.includes('voucher')) {
        return "Saat ini kami memiliki promo spesial:\n\n🔥 Paket Hemat 5GB + 5GB hanya Rp 7.500 (normal Rp 10.000)\n🎁 Beli 2 Panel Unli gratis 1 Panel 5GB\n\nPromo berlaku hingga akhir bulan. Gunakan kode 'HEMAT10' untuk diskon tambahan 10%! Info lengkap: https://buylink.id/Tiyanstore";
      }
      else if (normalizedMessage.includes('cs') || normalizedMessage.includes('customer service') || normalizedMessage.includes('bantuan')) {
        return "Tim customer service kami siap membantu 24 jam melalui:\n\n📞 WhatsApp: https://wa.me/6285972533957\n📧 Email: support@tiyanstore.com\n\nAnda juga bisa bergabung dengan grup WhatsApp resmi kami untuk informasi lebih cepat: https://chat.whatsapp.com/EQkSNg1QgWG0pEaGWwdnuv";
      }
      else if (normalizedMessage.includes('status') || normalizedMessage.includes('pesanan') || normalizedMessage.includes('order')) {
        return "Untuk mengecek status pesanan, Anda perlu:\n\n1. ID Transaksi (contoh: TY-20240620-123)\n2. Email yang digunakan saat pembelian\n\nSilakan kirim detail tersebut atau screenshot bukti transfer ke CS kami di https://wa.me/6285972533957 untuk bantuan lebih lanjut.";
      }
      else if (normalizedMessage.includes('grup whatsapp') || normalizedMessage.includes('grup wa') || normalizedMessage.includes('grup bot')) {
        return "Anda bisa bergabung dengan Grup WhatsApp resmi kami untuk mendapatkan informasi terbaru dan berdiskusi dengan komunitas kami:\n\n📱 Klik di sini untuk bergabung: https://chat.whatsapp.com/EQkSNg1QgWG0pEaGWwdnuv\n\nDi grup ini, Anda bisa mendapatkan update promo, bertanya langsung ke admin, dan berbagi pengalaman dengan pengguna lain.";
      }
      else if (normalizedMessage.includes('halo') || normalizedMessage.includes('hai') || normalizedMessage.includes('hello')) {
        return "Halo juga! 😊 Senang bisa membantu Anda hari ini. Ada yang bisa saya bantu seputar produk panel kami?";
      }
      else if (normalizedMessage.includes('terima kasih') || normalizedMessage.includes('thanks') || normalizedMessage.includes('makasih')) {
        return "Sama-sama! 😊 Jika ada pertanyaan lain, jangan ragu untuk bertanya ya. Semoga harimu menyenangkan!";
      }
      else {
        const randomResponses = [
          "Saya bisa membantu dengan informasi produk dan pembelian. Bisakah Anda menjelaskan lebih detail pertanyaan Anda?",
          "Maaf, saya belum sepenuhnya memahami pertanyaan Anda. Mungkin Anda bisa menanyakan tentang:\n- Daftar produk\n- Harga dan promo\n- Cara pembayaran\n- Status pesanan",
          "Untuk pertanyaan yang lebih spesifik, Anda bisa menghubungi tim customer service kami di https://wa.me/6285972533957",
          "Saya adalah AI Assistant khusus untuk informasi produk. Ada yang bisa saya bantu terkait panel kami?"
        ];
        return randomResponses[Math.floor(Math.random() * randomResponses.length)];
      }
    }

    async function sendMessage() {
      const message = chatInput.value.trim();
      if (message !== '') {
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'chat-message user-message';
        
        const userHeader = document.createElement('div');
        userHeader.className = 'message-header';
        userHeader.innerHTML = `<strong>Anda</strong><span class="message-time">${getCurrentTime()}</span>`;
        
        userMessageDiv.appendChild(userHeader);
        userMessageDiv.appendChild(document.createTextNode(message));
        chatBody.appendChild(userMessageDiv);
        
        conversationHistory.push({ role: "user", content: message });
        
        chatInput.value = '';
        
        chatBody.scrollTop = chatBody.scrollHeight;
        
        showTypingIndicator();
        sendButton.disabled = true;
        
        const aiResponse = await getAIResponse(message);
        
        hideTypingIndicator();
        sendButton.disabled = false;
        
        const botMessageDiv = document.createElement('div');
        botMessageDiv.className = 'chat-message bot-message';
        
        const botHeader = document.createElement('div');
        botHeader.className = 'message-header';
        botHeader.innerHTML = `<strong>AI Assistant</strong><span class="message-time">${getCurrentTime()}</span>`;
        
        botMessageDiv.appendChild(botHeader);
        
        const contentDiv = formatMessageWithLinks(aiResponse);
        botMessageDiv.appendChild(contentDiv);
        
        if (conversationHistory.length <= 2) {
          const suggestedDiv = document.createElement('div');
          suggestedDiv.innerHTML = addSuggestedQuestionsHTML();
          botMessageDiv.appendChild(suggestedDiv);
        }
        
        chatBody.appendChild(botMessageDiv);
        
        conversationHistory.push({ role: "assistant", content: aiResponse });
        
        chatBody.scrollTop = chatBody.scrollHeight;
      }
    }

    chatButton.addEventListener('click', function() {
      chatContainer.style.display = 'flex';
      document.getElementById('loadingOverlay').style.display = 'none';
    });

    closeChatButton.addEventListener('click', function() {
      saveCurrentConversationToHistory();
      chatContainer.style.display = 'none';
      clearChat();
    });

    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    sendButton.addEventListener('click', sendMessage);

    document.getElementById('chat-go-to-store').addEventListener('click', function() {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loading-text').textContent = 'Mengarahkan ke Web Store...';
      setTimeout(() => {
        window.location.href = 'https://buylink.id/Tiyanstore';
      }, 1000);
    });

    document.getElementById('chat-go-to-payment').addEventListener('click', function() {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('loading-text').textContent = 'Mengarahkan ke halaman pembayaran...';
      setTimeout(() => {
        window.location.href = 'https://tiyanpalestine.github.io/Website-payment/';
      }, 1000);
    });

    // ==================== SALJU DAN DETEKSI MOBILE ====================
    const popupWarning = document.getElementById('popup-warning');
    const closePopupBtn = document.getElementById('close-popup');
    const canvas = document.getElementById('salju');
    const ctx = canvas.getContext('2d');
    let snowflakes = [];

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    function createSnowflakes() {
      for (let i = 0; i < 100; i++) {
        snowflakes.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: Math.random() * 4 + 1,
          speedY: Math.random() * 2 + 1,
          speedX: Math.random() * 1 - 0.5,
        });
      }
    }

    function drawSnowflakes() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'white';
      ctx.beginPath();
      for (let flake of snowflakes) {
        ctx.moveTo(flake.x, flake.y);
        ctx.arc(flake.x, flake.y, flake.radius, 0, Math.PI * 2);
      }
      ctx.fill();
      updateSnowflakes();
    }

    function updateSnowflakes() {
      for (let flake of snowflakes) {
        flake.y += flake.speedY;
        flake.x += flake.speedX;
        if (flake.y > canvas.height) {
          flake.y = -flake.radius;
          flake.x = Math.random() * canvas.width;
        }
      }
    }

    function animateSnow() {
      drawSnowflakes();
      requestAnimationFrame(animateSnow);
    }

    function isMobileDevice() {
      return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0) || /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|rim)|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(navigator.userAgent||navigator.vendor||window.opera);
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    createSnowflakes();
    animateSnow();

    if (isMobileDevice()) {
      popupWarning.style.display = 'flex';
    }

    closePopupBtn.addEventListener('click', function() {
        popupWarning.style.display = 'none';
        if (!isMusicPlaying) {
            tryPlayMusic();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('loadingOverlay').style.display = 'none';
      initChat();
      startProductGlitchEffect();
      tryPlayMusic();
    });

    function startProductGlitchEffect() {
      const productItems = document.querySelectorAll('.produk-item');
      
      function triggerGlitch(item) {
        if (!item.querySelector('.produk-glitch')) {
          const glitch = document.createElement('div');
          glitch.className = 'produk-glitch';
          glitch.style.backgroundImage = `url('${item.querySelector('img').src}')`;
          item.appendChild(glitch);
        }
        const glitch = item.querySelector('.produk-glitch');
        const intensity = Math.random() * 0.5;
        glitch.style.opacity = intensity;
        setTimeout(() => {
          glitch.style.opacity = '0';
          setTimeout(() => triggerGlitch(item), Math.random() * 5000 + 3000);
        }, 200);
      }
      
      productItems.forEach(item => {
        setTimeout(() => triggerGlitch(item), Math.random() * 3000);
      });
    }
  </script>
</body>
</html>
